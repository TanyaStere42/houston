![Tests](https://github.com/WildMeOrg/houston/workflows/Testing/badge.svg?branch=develop)
[![Codecov](https://codecov.io/gh/WildMeOrg/houston/branch/develop/graph/badge.svg?token=M8MR14ED6V)](https://codecov.io/gh/WildMeOrg/houston)
[![Docker Nightly](https://img.shields.io/docker/image-size/wildme/houston/nightly)](https://hub.docker.com/r/wildme/houston)

# Wild Me - Houston Backend Server

Houston is a REST API component within the CODEX application suite. It is used to glue the frontend to [Ecological Data Module (EDM)](https://github.com/WildMeOrg/wildbook/tree/next-gen) and [Wildbook-IA](https://github.com/WildMeOrg/wildbook-ia).

For a high-level explanation of the application in relation to other CODEX applications read the documentation at [CODEX - Houston](https://docs.wildme.org/docs/developers/houston).


## About this implementation

This project showcases my vision on how the RESTful API server should be
implemented.

The goals that were achieved in this example:

* RESTful API server should be self-documented using OpenAPI (fka Swagger) specifications, so interactive documentation UI is in place
* Authentication is handled with OAuth2 and using Resource Owner Password Credentials Grant (Password Flow) for first-party clients makes it usable not only for third-party "external" apps
* Permissions are handled (and automaticaly documented)
* PATCH method can be handled accordingly to [RFC 6902](http://tools.ietf.org/html/rfc6902)
* Extensive testing with good code coverage.

The package Flask-RESTX has been patched (see `flask_restx_patched` folder), so it can handle Marshmallow schemas and Webargs arguments.

## Code Style and Development Guidelines

See [Contributing to Houston](CONTRIBUTING.md)

## Project's Code Structure

See [Project Structure](PROJECT_STRUCTURE.md)

## Installation

### Using docker-compose (recommended)

#### Setup

```bash
git clone --recurse-submodules https://github.com/WildMeOrg/houston.git
cd houston
# build the frontend
./scripts/build.frontend.sh
cd deploy/codex
docker-compose up
```

Surf to http://localhost:84/

#### Developer Usage Note

To use the docker setup as a development environment:

```bash
docker-compose exec houston /bin/bash
```

This will give you a bash shell prompt within the container that is currently running houston. You can do any operation mentioned in this document within this shell (e.g. `pytest`).

### Installing from source

#### Clone the Project

```bash
git clone --recurse-submodules https://github.com/WildMeOrg/houston.git
cd houston/
```

#### Setup Environment

It is recommended to use virtualenv or Anaconda/Miniconda to manage Python
dependencies. Please, learn details yourself.
For quickstart purposes the following will set up a virtualenv for you:

```bash
./scripts/venv.sh
source virtualenv/houston3.7/bin/activate

# To add bash-completion
export SCRIPT="$(pwd)/.invoke-completion.sh"
invoke --print-completion-script bash > $SCRIPT
echo "source $SCRIPT" >> virtualenv/houston3.7/bin/activate
```

Set up and install the package:

```bash
tar -zxvf _db.initial.tar.gz
pip install -e .
invoke app.dependencies.install
./scripts/build.frontend.sh
```

#### Run Server

NOTE: All dependencies and database migrations will be automatically handled,
so go ahead and turn the server ON! (Read more details on this in Tips section)

```bash
$ invoke app.run
```

#### Deploy Server

In general, you deploy this app as any other Flask/WSGI application. There are
a few basic deployment strategies documented in the [`./deploy/`](./deploy/)
folder.


## Usage

Open online interactive API documentation:
[http://127.0.0.1:5000/api/v1/](http://127.0.0.1:5000/api/v1/)

Autogenerated swagger config is always available from
[http://127.0.0.1:5000/api/v1/swagger.json](http://127.0.0.1:5000/api/v1/swagger.json)

NOTE: Use On/Off switch in documentation to sign in.


## Dependencies

### Project Dependencies

This project requires either [**Python**](https://www.python.org/) >= 3.7 or Docker.

The [_tus_](https://tus.io) portions of this application require [**Redis**](https://redis.io/) to facilitate resumable file uploads.

[**GitLab**](https://about.gitlab.com/install/) (community edition) is required for asset and submission storage and management.

[**Postgres**](https://www.postgresql.org/) is an optional dependency that can be used for a highly reliable scaled database solution.


Tips
----

Once you have invoke, you can learn all available commands related to this
project from:

```bash
$ invoke --list
```

Learn more about each command with the following syntax:

```bash
$ invoke --help <task>
```

For example:

```bash
$ invoke --help app.run
Usage: inv[oke] [--core-opts] app.run [--options] [other tasks here ...]

Docstring:
  Run DDOTS RESTful API Server.

Options:
  -d, --[no-]development
  -h STRING, --host=STRING
  -i, --[no-]install-dependencies
  -p, --port
  -u, --[no-]upgrade-db
```

Use the following command to enter ipython shell (`ipython` must be installed):

```bash
$ invoke app.env.enter
```

`app.run` and `app.env.enter` tasks automatically prepare all dependencies
(using `pip install`) and migrate database schema to the latest version.

Database schema migration is handled via `app.db.*` tasks group. The most
common migration commands are `app.db.upgrade` (it is automatically run on
`app.run`), and `app.db.migrate` (creates a new migration).

You can use [`better_exceptions`](https://github.com/Qix-/better-exceptions)
package to enable detailed tracebacks. Just add `better_exceptions` to the
`app/requirements.txt` and `import better_exceptions` in the `app/__init__.py`.


Marshmallow Tricks
------------------

There are a few helpers already available in the `flask_restx_patched`:

* `flask_restx_patched.parameters.Parameters` - base class, which is a thin
  wrapper on top of Marshmallow Schema.
* `flask_restx_patched.parameters.PostFormParameters` - a helper class,
  which automatically mark all the fields that has no explicitly defined
  location to be form data parameters.
* `flask_restx_patched.parameters.PatchJSONParameters` - a helper class for
  the common use-case of [RFC 6902](http://tools.ietf.org/html/rfc6902)
  describing JSON PATCH.
* `flask_restx_patched.namespace.Namespace.parameters` - a helper decorator,
  which automatically handles and documents the passed `Parameters`.

You can find the examples of the usage throughout the code base (in
`/app/modules/*`).


### JSON Parameters

While there is an implementation for JSON PATCH Parameters, there are other
use-cases, where you may need to handle JSON as input parameters. Naturally,
JSON input is just a form data body text which is treated as JSON on a server
side, so you only need define a single variable called `body` with
`location='json'`:

```python
class UserSchema(Schema):
    id = base_fields.Integer(required=False)
    username = base_fields.String(required=True)


class MyObjectSchema(Schema):
    id = base_fields.Integer(required=True)
    priority = base_fields.String(required=True)
    owner = base_fields.Nested(UserSchema, required=False)


class CreateMyObjectParameters(Parameters):
    body = base_fields.Nested(MyObjectSchema, location='json', required=True)


api = Namespace('my-objects-controller', description="My Objects Controller", path='/my-objects')


@api.route('/')
class MyObjects(Resource):
    """
    Manipulations with My Objects.
    """

    @api.parameters(CreateMyObjectParameters())
    @api.response(MyObjectSchema())
    @api.response(code=HTTPStatus.CONFLICT)
    @api.doc(id='create_my_object')
    def post(self, args):
        """
        Create a new My Object.
        """
        return create_my_object(args)
```

How to Update Schemas / Create a Migration
============
1. Update schema objects in `/app/modules`
2. Run `invoke app.db.migrate` to create an auto generated migration or `invoke app.db.revision` to create an empty migration for non-schema updates
3. A new file should have been created in `/app/migrations/versions`
4. Run `invoke app.db.upgrade`

RFC 6902 Compliance
============
This implementation is compatible with RFC6509 with the exception that for removal of list items via patch. This implementation supports an optional value in the patch removal operation to permit deletion of associations between modules.

Useful Links
============

* "[The big Picture](https://identityserver.github.io/Documentation/docsv2/overview/bigPicture.html)" -
  short yet complete idea about how the modern apps should talk.
* "[Please. Don't PATCH Like An Idiot.](http://williamdurand.fr/2014/02/14/please-do-not-patch-like-an-idiot/)"
* "[A Concise RESTful API Design Guide](https://twincl.com/programming/*6af/rest-api-design)"
* "[Best Practices for Designing a Pragmatic RESTful API](http://www.vinaysahni.com/best-practices-for-a-pragmatic-restful-api)"
* "[My take on RESTful authentication](https://facundoolano.wordpress.com/2013/12/23/my-take-on-restful-authentication/)"
* "[Is it normal design to completely decouple backend and frontend web applications and allow them to communicate with (JSON) REST API?](http://softwareengineering.stackexchange.com/questions/337467/is-it-normal-design-to-completely-decouple-backend-and-frontend-web-applications)"
